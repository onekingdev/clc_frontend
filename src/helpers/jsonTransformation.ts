
// @ts-ignore
let hands: string[]  = [`
***** Hand History for Game 17220539837 *****
NL Texas Hold'em $2600 USD Buy-in Trny:169802661 Level:3  Blinds-Antes(600/1.2K -150) - Sunday,April 22, 13:45:13 EDT 2018
Table Super Sunday High Roller-SHR: $200K Gtd (169802661) Table #3 (Real Money)
Seat 5 is the button
Total number of players : 7/8
Seat 1: shadoww0rm ( 239,061  )
Seat 2: probirs ( 108,930  )
Seat 3: mwhldwn ( 164,351  )
Seat 4: OldManInTheSea ( 101,110  )
Seat 5: shlongoperator ( 82,462  )
Seat 6: DrMiKee ( 109,510  )
Seat 7: NVoskob1986 ( 83,050  )
Trny:169802661 Level:3
Blinds-Antes(600/1,200 -150)
shadoww0rm posts ante [150 ]
probirs posts ante [150 ]
mwhldwn posts ante [150 ]
OldManInTheSea posts ante [150 ]
shlongoperator posts ante [150 ]
DrMiKee posts ante [150 ]
NVoskob1986 posts ante [150 ]
DrMiKee posts small blind [600 ].
NVoskob1986 posts big blind [1,200 ].
** Dealing down cards **
Dealt to OldManInTheSea [ 2c, Ac ]
shadoww0rm raises [ 2,400  ]
probirs calls [ 2,400  ]
mwhldwn folds
OldManInTheSea raises [ 10,600  ]
shlongoperator folds
DrMiKee folds
NVoskob1986 folds
shadoww0rm folds
probirs will be using their time bank for this hand.
probirs calls [ 8,200  ]
** Dealing Flop ** [ 9s, Ad, Ah ]
probirs checks
`,
`
***** Hand History for Game 17750042178 *****
NL Texas Hold'em $2600 USD Buy-in Trny:180571031 Level:5  Blinds-Antes(800/1.6K -200) - Thursday,September 20, 13:40:07 EDT 2018
Table Powerfest Tickets: 2 x $25,500 Gtd Hyper (180571031) Table #1 (Real Money)
Seat 2 is the button
Total number of players : 6/6
Seat 1: p0kchkmonsta ( 97,225  )
Seat 2: Maese00 ( 93,749  )
Seat 3: fren96 ( 100,000  )
Seat 4: dominos5524 ( 92,729  )
Seat 5: ChanceSeeYou ( 100,649  )
Seat 6: Get1nTheBin ( 214,848  )
Trny:180571031 Level:5
Blinds-Antes(800/1,600 -200)
p0kchkmonsta posts ante [200 ]
Maese00 posts ante [200 ]
dominos5524 posts ante [200 ]
ChanceSeeYou posts ante [200 ]
Get1nTheBin posts ante [200 ]
dominos5524 posts small blind [800 ].
ChanceSeeYou posts big blind [1,600 ].
** Dealing down cards **
Dealt to ChanceSeeYou [ Tc, As ]
Get1nTheBin raises [ 3,200  ]
p0kchkmonsta folds
Maese00 folds
dominos5524 calls [ 2,400  ]
ChanceSeeYou calls [ 1,600  ]
** Dealing Flop ** [ 9c, 4d, Td ]
dominos5524 checks
ChanceSeeYou checks
Get1nTheBin bets [ 4,000  ]
dominos5524 folds
ChanceSeeYou calls [ 4,000  ]
** Dealing Turn ** [ Ts ]
ChanceSeeYou checks
Get1nTheBin checks
** Dealing River ** [ 3s ]
`,
`
PokerStars Hand #193786644452: Tournament #2462902993, $250+$250+$30 USD Hold'em No Limit - Level XXV (6000/12000) - 2018/11/26 19:32:44 ET
Table '2462902993 3' 9-max Seat #3 is the button
Seat 2: Kobasteris (493771 in chips, $1671.87 bounty)
Seat 3: ruathan1368 (1620503 in chips, $2125 bounty)
Seat 4: Poeira4 (161720 in chips, $2171.87 bounty)
Seat 5: ChanceCU (1158586 in chips, $902.34 bounty)
Seat 7: Moorman1 (506036 in chips, $1750 bounty)
Seat 8: Creatiff111 (401692 in chips, $1664.06 bounty)
Seat 9: jmslee21 (605123 in chips, $1800.78 bounty)
Kobasteris: posts the ante 1500
ruathan1368: posts the ante 1500
Poeira4: posts the ante 1500
ChanceCU: posts the ante 1500
Moorman1: posts the ante 1500
Creatiff111: posts the ante 1500
jmslee21: posts the ante 1500
Poeira4: posts small blind 6000
ChanceCU: posts big blind 12000
*** HOLE CARDS ***
Dealt to ChanceCU [Jd Jh]
Moorman1: folds
Creatiff111: folds
jmslee21: raises 13200 to 25200
Kobasteris: folds
ruathan1368: calls 25200
Poeira4: folds
`,
`
Game Hand #119071149 - Tournament #11726624 - Holdem(No Limit) - Level 24 (40000.00/80000.00)- 2019/09/23 02:06:02 UTC
Table '85' 9-max Seat #8 is the button
Seat 1: FishSharkKK (2349920.00)
Seat 2: 1grjnaej (1714564.00)
Seat 3: LawyerDad68 (1682624.00)
Seat 4: 4Bet Jesus (1175086.00)
Seat 5: Fun Player (5092204.00)
Seat 6: NutInsider (4388522.00)
Seat 7: SmellyFoot (1569266.00)
Seat 8: ChiefB0ngWater (2375690.00)
Seat 9: fibLEVELS (3526564.00)
FishSharkKK posts ante 10000.00
1grjnaej posts ante 10000.00
LawyerDad68 posts ante 10000.00
4Bet Jesus posts ante 10000.00
Fun Player posts ante 10000.00
NutInsider posts ante 10000.00
SmellyFoot posts ante 10000.00
ChiefB0ngWater posts ante 10000.00
fibLEVELS posts ante 10000.00
fibLEVELS posts the small blind 40000.00
FishSharkKK posts the big blind 80000.00
*** HOLE CARDS ***
Main pot 90000.00
Dealt to LawyerDad68 [Kh Jd]
1grjnaej folds
LawyerDad68 raises 160000.00 to 160000.00
4Bet Jesus folds
Fun Player folds
NutInsider folds
SmellyFoot folds
ChiefB0ngWater folds
fibLEVELS folds
FishSharkKK calls 80000.00
*** FLOP *** [5h 8h Ad]
Main pot 450000.00
FishSharkKK checks
LawyerDad68 bets 125000.00
FishSharkKK calls 125000.00
*** TURN *** [5h 8h Ad] [Qs]
Main pot 700000.00
FishSharkKK checks
`
]

const parseRecord = (record: string) => {
    const records = record.split("\n");
    let players = [];
    let flop: string[] = [];
    let mapPlayers: { [key: string]: any} = {}
    let hands = [];
    for (let i = 0; i < records.length; i++) {
        const line = records[i];
        const regex = /Seat\s+[#?|\']?(?<seat_number>\d+)\'?:\s+(?<seat_name>\w+[\s+\w+]*)\s+\(\s*(?<seat_amount>([0-9]{1,3}(\,[0-9]{1,3})*)*(\.[0-9]{1,2})?)\s*\)/
        const result = regex.exec(line)?.groups

        if (result) {
            const player = {
                number: result.seat_number,
                name: result.seat_name,
                initAmount: result.seat_amount,
                cards: []
            }
            players.push(player);
            // @ts-ignore
            mapPlayers[player.name] =  player;
        }

    }

    const words = players.map(p => `\\b${p.name.replace(" ", "\\s+")}\\b`).join("|")
    const strRegex = `(?<seat_name>${words})\\s+(?<hand>[A-Za-z]+(\\s+[A-Za-z]+)*)(\\s*)\\[?(\\s*)(?<seat_amount>([0-9]{1,3}(\\,[0-9]{1,3})*)*(\\.[0-9]{1,2})?)?(\\s*)\\]?`;
    const handRegex = new RegExp(strRegex)
    const dealRegex = new RegExp(`\\bDealt\\b\\s+\\bto\\b\\s+(?<seat_name>${words})\\s+\\[*\\s*(?<cards>[a-zA-Z0-9]{2}(\\,?\\s*[a-zA-Z0-9]{2})*)\\s*\\]*`)
    const flopRegex = /\*+\s+(\bDealing\s+Flop\b)\s+\*+\s+\[\s*(?<cards>[a-zA-Z0-9]{2}(\,?\s*[a-zA-Z0-9]{2})*)\s*\]/
    const turnRegex = /\*+\s+(\bDealing\s+Turn\b)\s+\*+\s+\[\s*(?<card>[a-zA-Z0-9]{2}(\,?\s*[a-zA-Z0-9]{2})*)\s*\]/
    const riverRegex = /\*+\s+(\bDealing\s+River\b)\s+\*+\s+\[\s*(?<card>[a-zA-Z0-9]{2}(\,?\s*[a-zA-Z0-9]{2})*)\s*\]/

    let flopIndex = 0;
    for (let i = 0; i < records.length; i++) {
        const line = records[i];
        let result = flopRegex.exec(line)?.groups

        if (result && result.cards) {
            flop = result.cards.replace(/ /g, '').split(',');
            flopIndex = i;
        }

    }

    let turnIndex = 0;
    for (let i = 0; i < records.length; i++) {
        const line = records[i];
        let result = turnRegex.exec(line)?.groups

        if (result && result.card) {
            flop.push(result.card);
            turnIndex = i;
        }

    }

    let riverIndex = 0;
    for (let i = 0; i < records.length; i++) {
        const line = records[i];
        let result = riverRegex.exec(line)?.groups

        if (result && result.card) {
            flop.push(result.card);
            riverIndex = i;
        }

    }

    for (let i = 0; i < records.length; i++) {
        const line = records[i];
        let result = dealRegex.exec(line)?.groups

        if (result) {
            if (mapPlayers[result.seat_name]) {
                mapPlayers[result.seat_name].cards = result.cards.split(/,\s*/);
            }
        }

    }
    let bb = 0;
    let sb = 0;
    let ante = 0;
    for (let i = 0; i < records.length; i++) {
        const line = records[i];
        let result = handRegex.exec(line)?.groups

        if (result) {
            if (result.hand.trim() === 'posts small blind') {
                sb = parseInt(result.seat_amount.replace(/,/g, ''), 10)
            } else if (result.hand.trim() === 'posts big blind') {
                bb = parseInt(result.seat_amount.replace(/,/g, ''), 10)
            } else if (result.hand.trim() === 'posts ante') {
                ante = parseInt(result.seat_amount.replace(/,/g, ''), 10)
            }

            hands.push({
                player: parseInt(mapPlayers[result.seat_name].number),
                totalChips: parseInt(mapPlayers[result.seat_name].initAmount.replace(/,/g, ''), 10),
                playerName: result.seat_name,
                action: result.hand.trim(),
                bet: result.seat_amount ? parseInt(result.seat_amount.replace(/,/g, ''), 10) : 0,
                cards: mapPlayers[result.seat_name].cards,
                tableAction: flopIndex > 0 && flopIndex-1 === i ? 'flop' : turnIndex > 0 && turnIndex-1 === i ? 'turn' : riverIndex > 0 && riverIndex-1 === i ? 'river' : ''
            });
        }
    }

    const dealerIndex = record.search('is the button');
    const dealer = parseInt(record[dealerIndex-2])
    const generalInfo = {
        dealer,
        sb,
        bb,
        ante,
        players: players.length,
        pot: 0,
    }

    return handHistoryJsonCreator(generalInfo, flop, hands)
}

const returnCard = (card: string) => {
    let data = {type: '', value: '', show: true};
    switch (card[0]) {
        case '2':
            data.value = 'two';
            break;
        case '3':
            data.value = 'three';
            break;
        case '4':
            data.value = 'four';
            break;
        case '5':
            data.value = 'five';
            break;
        case '6':
            data.value = 'six';
            break;
        case '7':
            data.value = 'seven';
            break;
        case '8':
            data.value = 'eight';
            break;
        case '9':
            data.value = 'nine';
            break;
        case 'T':
            data.value = 'ten';
            break;
        case 'J':
            data.value = 'j';
            break;
        case 'Q':
            data.value = 'q';
            break;
        case 'K':
            data.value = 'k';
            break;
        case 'A':
            data.value = 'a';
            break;
    }
    switch (card[1]) {
        case 'h':
            data.type = 'hearts';
            break;
        case 'c':
            data.type = 'clubs';
            break;
        case 's':
            data.type = 'spades';
            break;
        case 'd':
            data.type = 'diamonds';
            break;
    }
    return data
}

const handHistoryJsonCreator = (generalInfo: {dealer: number, ante: number, bb: number, sb: number, pot: number, players: number}, flop: string[], play: {player: number, action: string, totalChips: number, bet: number, cards: string[], tableAction: string}[]) => {
    let roundIndex = 0;
    // @ts-ignore
    let rounds: {seats: any[]}[] = [
        {seats: []},{seats: []},{seats: []}
        ];
    let player = -1;
    let me: any;

    play.forEach((item, i) => {
        if (item.cards.length > 0) me = item;
        if (item.action === 'posts ante' || item.action === 'posts the ante') {
            rounds[roundIndex].seats.push({
                player: item.player,
                dealer: generalInfo.dealer === item.player,
                mp: item.totalChips,
                action: {type: 'ante', amount: item.bet},
                tableAction: item.tableAction
            })
        } else if (item.action === 'posts small blind' || item.action === 'posts the small blind') {
            player = item.player;
            roundIndex+=1;
            rounds[roundIndex].seats.push({
                player: item.player,
                dealer: generalInfo.dealer === item.player,
                sb: generalInfo.sb,
                mp: item.totalChips,
                action: {type: 'call', amount: item.bet},
                cardOne: item.cards.length === 0 ? {value: '', type: '', show: false} : returnCard(item.cards[0]),
                cardTwo: item.cards.length === 0 ? {value: '', type: '', show: false} : returnCard(item.cards[1]),
                tableAction: item.tableAction
            })
        } else if (item.action === 'posts big blind' || item.action === 'posts the big blind') {
            rounds[roundIndex].seats.push({
                player: item.player,
                dealer: generalInfo.dealer === item.player,
                bb: generalInfo.bb,
                mp: item.totalChips,
                action: {type: 'call', amount: item.bet},
                cardOne: item.cards.length === 0 ? {value: '', type: '', show: false} : returnCard(item.cards[0]),
                cardTwo: item.cards.length === 0 ? {value: '', type: '', show: false} : returnCard(item.cards[1]),
                tableAction: item.tableAction
            })
        } else {
            if (item.player === player) {
                roundIndex += 1;
            }
            if (play[i-1].player !== item.player && (item.action === 'raises' || item.action === 'calls' || item.action === 'checks' || item.action === 'folds')) {
                rounds[roundIndex].seats.push({
                    player: item.player,
                    dealer: generalInfo.dealer === item.player,
                    mp: item.totalChips,
                    action: {
                        type: item.action === 'raises' ? 'raise' : item.action === 'calls' ? 'call' : item.action === 'checks' ? 'check' : 'fold',
                        amount: item.action !== 'checks' ? item.bet : null
                    },
                    cardOne: item.cards.length === 0 ? {value: '', type: '', show: false} : returnCard(item.cards[0]),
                    cardTwo: item.cards.length === 0 ? {value: '', type: '', show: false} : returnCard(item.cards[1]),
                    tableAction: item.tableAction
                })
            }
        }
    });
    rounds[roundIndex].seats.push({
        player: me.player,
        dealer: generalInfo.dealer === me.player,
        mp: me.totalChips,
        action: {
            type: 'NAN',
            amount: 0
        },
        cardOne: returnCard(me.cards[0]),
        cardTwo: returnCard(me.cards[1]),
    })

    let data = {
        ante: generalInfo.ante,
        bb: generalInfo.bb,
        sb: generalInfo.sb,
        pot: generalInfo.pot,
        players: generalInfo.players,
        rounds: rounds,
        flop: [
            flop[0] ? {...returnCard(flop[0]), show: false} : {type: '', value: '', show: false},
            flop[1] ? {...returnCard(flop[1]), show: false} : {type: '', value: '', show: false},
            flop[2] ? {...returnCard(flop[2]), show: false} : {type: '', value: '', show: false},
            flop[3] ? {...returnCard(flop[3]), show: false} : {type: '', value: '', show: false},
            flop[4] ? {...returnCard(flop[4]), show: false} : {type: '', value: '', show: false},
        ],
        question: {
            reward: {chips: 4, tickets: 1},
            description: 'Based on contextual information. What is the best decision?',
            header: 'Post Flop Problems',
            questionNumber: 2,
            answers: [
                {
                    correct: false,
                    text: 'Call',
                    explanation: 'Mauris varius falis commodo impredit. crass faucibius egeases urnas, sed cursus massa cursus in. Ut aliquam loborus arcu. Fucsu id arcu eget nisi porta blandit etiam mollis massa et ipusm timndum'
                },
                {
                    correct: true,
                    text: 'Fold',
                    explanation: 'Mauris varius falis commodo impredit. crass faucibius egeases urnas, sed cursus massa cursus in. Ut aliquam loborus arcu. Fucsu id arcu eget nisi porta blandit etiam mollis massa et ipusm timndum'
                },
                {
                    correct: false,
                    text: 'Raise',
                    explanation: 'Mauris varius falis commodo impredit. crass faucibius egeases urnas, sed cursus massa cursus in. Ut aliquam loborus arcu. Fucsu id arcu eget nisi porta blandit etiam mollis massa et ipusm timndum'
                },
                {
                    correct: false,
                    text: 'Bet 1/3',
                    explanation: 'Mauris varius falis commodo impredit. crass faucibius egeases urnas, sed cursus massa cursus in. Ut aliquam loborus arcu. Fucsu id arcu eget nisi porta blandit etiam mollis massa et ipusm timndum'
                }
            ]
        }
    }

    return data;
}

export const extract = parseRecord(hands[0]);